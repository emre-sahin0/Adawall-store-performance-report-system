// Veri gönderme sıklığını artır ve değişiklik eşiği ekle
const sendDataInterval = 10000; // 10 saniyede bir gönder
const changeThreshold = 0.05; // %5'ten fazla değişiklik olmadıkça gönderme
let lastSendTime = 0;
let lastData = null;

function hasSignificantChange(newData, oldData) {
    if (!oldData) return true;
    
    // CPU değişikliğini kontrol et
    const cpuUsageChange = Math.abs(newData.cpu.usage - oldData.cpu.usage);
    if (cpuUsageChange > changeThreshold) return true;
    
    // Bellek değişikliğini kontrol et
    const memoryChange = Math.abs((newData.memory.used - oldData.memory.used) / newData.memory.total);
    if (memoryChange > changeThreshold) return true;
    
    // Disk değişikliğini kontrol et
    const diskChange = Math.abs((newData.disk.used - oldData.disk.used) / newData.disk.total);
    if (diskChange > changeThreshold) return true;
    
    // Ağ değişikliğini kontrol et (sadece aktif transfer varsa)
    if (newData.network.upload > 100 || newData.network.download > 100) {
        return true;
    }
    
    return false;
}

function sendDataToServer(data) {
    const currentTime = Date.now();
    
    // Eğer son gönderimden bu yana yeterli süre geçmediyse veya önemli bir değişiklik yoksa gönderme
    if (currentTime - lastSendTime < sendDataInterval || !hasSignificantChange(data, lastData)) {
        return;
    }

    // Veriyi filtrele ve optimize et
    const filteredData = {
        timestamp: data.timestamp,
        cpu: {
            usage: Math.round(data.cpu.usage * 100) / 100,
            temperature: Math.round(data.cpu.temperature * 100) / 100
        },
        memory: {
            total: Math.round(data.memory.total / 1024 / 1024), // MB cinsinden
            used: Math.round(data.memory.used / 1024 / 1024), // MB cinsinden
            free: Math.round(data.memory.free / 1024 / 1024) // MB cinsinden
        },
        disk: {
            total: Math.round(data.disk.total / 1024 / 1024 / 1024), // GB cinsinden
            used: Math.round(data.disk.used / 1024 / 1024 / 1024), // GB cinsinden
            free: Math.round(data.disk.free / 1024 / 1024 / 1024) // GB cinsinden
        },
        network: {
            upload: Math.round(data.network.upload / 1024), // KB/s cinsinden
            download: Math.round(data.network.download / 1024) // KB/s cinsinden
        }
    };

    // Sadece önemli değişiklikler olduğunda push gönder
    if (hasSignificantChange(filteredData, lastData)) {
        fetch('/api/data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filteredData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Veri başarıyla gönderildi:', data);
            lastSendTime = currentTime;
            lastData = filteredData;
        })
        .catch(error => {
            console.error('Veri gönderme hatası:', error);
        });
    }
}

// Veri toplama sıklığını azalt
setInterval(() => {
    const data = collectSystemData();
    sendDataToServer(data);
}, 2000); // 2 saniyede bir topla, 10 saniyede bir gönder 